## 转换为长格式
```r
ex01DataToLong <- function(data) {
  # your code
  assertDataTable(data)
  data[, .(school = school, subject = names(grades[[1]]), grade = grades[[1]]), by = student.id]
}
```
* `grade[[1]]:` 取出学生的成绩向量
* `names(grade[[1]]):` 取出科目名称
* `grade = grades[[1]]`: 取出成绩值


## (b)分组统计
```r
ex02DataStats <- function(data, group.by) {
  # your code
  assertDataTable(data)
  assertChoice(group.by, c("school", "subject", "both"))
  
  # 确定分组列
  group.by <- c(if (group.by != "subject") "school", 
			    if (group.by != "school") "subject")
	
  # 转长格式后分组统计
  ex01DataToLong(data)[, .(mean = mean(grade), sd = sd(grade)), by = group.by]
}
```


## (c)统计每个学校每个科目的学生数，包括没有开设的科目（显示0）
```r
ex03DataCount <- function(data) {
  # your code
  assertDataTable(data)
  
  # 转长格式
  data <- ex01DataToLong(data)
  
  # 统计每个学校每个科目的学生数
  aggr <- data[, .(students = length(student.id)), by = c("school", "subject")]
  
  # 与完整组合连接，补全缺失组合
  aggr <- aggr[CJ(school, subject, unique = TRUE), on = c("school", "subject")]
  
  # 填充 NA 为 0
  aggr$students <- nafill(aggr$students, fill = 0)
  aggr
}
```
* **CJ(x, y, unique):** **C**ross **J**oin(交叉连接), 生成所有可能的组合
	* unique = TRUE: 只取唯一值
* **nafill(x, fill):** 用于填充 NA 值的函数（只能用于数值型，字符型不能用）

## (d)
```r
ex04DataWide <- function(data) {
  # your code
  assertDataTable(data)
  
  # dcast 转宽格式
  dcast(ex01DataToLong(data)[, subject := paste0("grade.", subject)],
    student.id + school ~ subject, value.var = "grade")[data$student.id, on = "student.id"]  # `dcast()` 可能改变行顺序，用原始 `student.id` 顺序做连接，恢复顺序
}
```
* **长格式:** 列少，行多（每个测量值一行）
* **宽格式:** 行少，列多（每个观测对象一行，不同测量值放在不同列）
* **dcast(data, 行变量 ~ 列变量, value.var = "填充值"):** 长格式转宽格式
	* z.B: 
		* student --- 保留为行 --- 小明小红各一行
		* subject --- 展开为列 --- 数学，物理变成列名
		* value.var = "grade" --- 填充值 --- 成绩填入对应格子
```r
# 长格式数据
dt_long <- data.table(
  student = c("小明", "小明", "小红", "小红"),
  subject = c("数学", "物理", "数学", "物理"),
  grade   = c(90, 85, 95, 80)
)

dt_long
#    student subject grade
# 1:    小明    数学    90
# 2:    小明    物理    85
# 3:    小红    数学    95
# 4:    小红    物理    80

#使用 `dcast()`
dcast(dt_long, student ~ subject, value.var = "grade")

#    student 数学 物理
# 1:    小明   90   85
# 2:    小红   95   80
```