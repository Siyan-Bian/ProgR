## (a)按日期（年、月、日）对银行账单排序，从最早到最晚
```r
ex01SortLedger <- function(ledger) {
  # your code
  assertDataTable(ledger)
  ledger[order(yr, mth, day)]
}
```
* `order()` 返回排序后的索引位置，支持多列排序
	* 先按 yr 排序; yr 相同时，按 mth 排序; mth 相同时，按 day 排序


## (b)筛选出指定日期**之前**的所有交易记录
```r
ex02TrimLedger <- function(ledger, year, month, day) {
  assertDataTable(ledger)
  assertInt(year)
  assertInt(month, lower = 1, upper = 12)
  assertInt(day, lower = 1, upper = 31)
  
  # 先创建 cutoff，避免直接使用 day，引起变量名冲突
  cutoff <- ISOdate(year, month, day)  # 截止日期
  ledger[cutoff > ISOdate(yr, mth, day)]  # 等价于：筛选日期 < 截止日期 的行
}
```
* **ISOdate():** 将年、月、日转换为日期对象，便于比较
	* ISOdate(2008, 12, 8) **=>** "2008-12-08 12:00:00 GMT"


## (c)都是计算指定日期的账户余额
##### 方法1: Non-equi Join（非等值连接）
```r
ex03Balance <- function(ledger, query) {
  assertDataTable(ledger)
  assertDataTable(query)
  
  # 转换日期格式
  ledger <- copy(ledger)[, `:=`(date = ISOdate(yr, mth, day),
    yr = NULL, mth = NULL, day = NULL)]
  query <- copy(query)[, date := ISOdate(yr, mth, day)]

  # 对每个查询行计算收入和支出
  totals <- query[, .(
    # 收到的钱
    recv = ledger[.SD, sum(amt, na.rm = TRUE), on = .(dst = account, date <= date)],  # 找出该账户在查询日期**之前或当天**的所有交易
    # 转出的钱
    sent = ledger[.SD, sum(amt, na.rm = TRUE), on = .(src = account, date <= date)]
  ), by = seq_len(nrow(query))]
  
  # balance = recv - sent
  cbind(query, balance = totals[, recv - sent])[, date := NULL]
}
```

##### 方法2: Rolling Join（滚动连接）
```r
ex03Balance <- function(ledger, query) {
  assertDataTable(ledger)
  assertDataTable(query)
  
  # 步骤1: 转换日期
  ledger <- ledger[, .(date = ISOdate(yr, mth, day), src, dst, amt)]
  
  # 步骤2: 拆分为收入和支出记录
  ledger <- rbind(
    ledger[, .(date, account = dst, amount = amt)],   # 收款 +
    ledger[, .(date, account = src, amount = -amt)]   # 付款 -
  )[order(date)]
  
  # 步骤3: 计算累计余额
  ledger <- ledger[, .(date, balance = cumsum(amount)), by = account]
  
  # 步骤4: 每个日期只保留最后的余额
  ledger <- ledger[, .(balance = last(balance)), by = c("account", "date")]

  # 步骤5: Rolling join
  query <- query[, date := ISOdate(yr, mth, day)]
  ret <- ledger[query, on = .(account, date), roll = TRUE]
  
  # 步骤6: 填充 NA 为 0
  setnafill(ret, fill = 0, cols = "balance")
  ret[, .(yr, mth, day, account, balance)]
}
```
